<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Love Hydration</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3105/3105807.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --romance-pink: #ffafbd; --romance-red: #ff4b2b; --water-blue: #00d2ff; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to bottom, #ffafbd, #ffc3a0); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 420px; padding: 15px; padding-bottom: 90px; box-sizing: border-box; }
        .card { background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); margin-bottom: 15px; text-align: center; border: 2px solid white; }
        .progress-box { position: relative; width: 160px; height: 160px; margin: 15px auto; }
        .circular-progress { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: conic-gradient(var(--water-blue) 0deg, #ffebee 0deg); transition: 0.5s ease; }
        .inner-circle { width: 130px; height: 130px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; }
        .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .tab-item { border: none; background: none; color: #999; font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .tab-item.active { color: var(--romance-red); }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        input, select { width: 85%; padding: 12px; border-radius: 15px; border: 1px solid #ffafbd; margin: 10px 0; font-size: 1rem; text-align: center; }
        button { padding: 12px 20px; border: none; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 5px; width: 100%; }
        .admin-section { display: none; background: #fff3f3; padding: 15px; border-radius: 15px; border: 2px dashed #ff7675; margin-top: 15px; }
        #love-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 75, 43, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 2000; text-align: center; }
    </style>
</head>
<body>

<div id="love-overlay">
    <div style="font-size:100px; animation: heartbeat 0.8s infinite alternate;">â¤ï¸</div>
    <h1>I Love You!</h1>
    <p>Target reached! ğŸ˜˜</p>
    <button style="background: white; color: #ff4b2b; width: 200px;" onclick="document.getElementById('love-overlay').style.display='none'">Love You Too â¤ï¸</button>
</div>

<div class="container">
    <div id="p-home" class="page active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span>ğŸ¯ Target: <span id="display-goal">2000</span>ml</span>
                <span>ğŸª™ <span id="coin-count">0</span></span>
            </div>
            <div class="progress-box">
                <div id="progress" class="circular-progress">
                    <div class="inner-circle"><span id="current-ml" style="font-size:1.8rem; font-weight:bold;">0</span></div>
                </div>
            </div>
            <input type="number" id="drink-amount" value="250">
            <button style="background: #00d2ff;" onclick="drinkWater()">Drink ğŸ’§</button>
            <div style="font-size: 0.6rem; color: #999; margin-top: 10px;">ID: <span id="my-device-id"></span></div>
        </div>
    </div>

    <div id="p-request" class="page">
        <div class="card">
            <h3>ğŸ’Œ Goal Request</h3>
            <input type="number" id="request-goal-input" placeholder="New Target ml">
            <button style="background: #6c5ce7;" onclick="sendRequest()">Ask My Baby ğŸ’Œ</button>
            
            <button style="background: #ccc; margin-top: 20px; color: #333;" onclick="unlockAdmin()">Enter Admin Key ğŸ”’</button>
            
            <div id="admin-controls" class="admin-section">
                <h4>ğŸ”’ Live Admin Panel</h4>
                <p style="font-size: 0.8rem;">Monitor & Manage Devices:</p>
                <select id="admin-target-user" onchange="switchAdminTarget()"></select>

                <div id="admin-actions" style="display:none; margin-top: 15px;">
                    <input type="number" id="admin-coins" placeholder="Set Total Coins">
                    <button style="background:#2ecc71;" onclick="adminUpdateCoins()">Update Coins</button>
                    <input type="number" id="admin-goal" placeholder="Set Daily Goal">
                    <button style="background:#e67e22;" onclick="adminUpdateGoal()">Set Goal</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-bar">
    <button class="tab-item active" onclick="showPage('home')">ğŸ <span>Home</span></button>
    <button class="tab-item" onclick="showPage('request')">ğŸ’Œ<span>Admin</span></button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAkDjO1Zk_KsqnBhOYdZw8hX6ebcDv2TM8",
        authDomain: "watertracker-7c2d3.firebaseapp.com",
        databaseURL: "https://watertracker-7c2d3-default-rtdb.firebaseio.com",
        projectId: "watertracker-7c2d3",
        storageBucket: "watertracker-7c2d3.firebasestorage.app",
        messagingSenderId: "1085308071765",
        appId: "1:1085308071765:web:4fd76906f520bbde2b09dc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let myId = localStorage.getItem('loveTrackerUserId') || 'Baby_' + Math.random().toString(36).substr(2, 4).toUpperCase();
    localStorage.setItem('loveTrackerUserId', myId);
    document.getElementById('my-device-id').innerText = myId;

    // --- LIVE STATUS HEARTBEAT ---
    function updatePresence() {
        const now = Date.now();
        const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        db.ref('users/' + myId).update({ 
            lastActive: now,
            lastSeen: timeStr 
        });
    }
    setInterval(updatePresence, 5000); // Heartbeat every 5 seconds
    updatePresence();

    let stats = { daily: {}, coins: 0, goal: 2000 };
    let adminTargetId = "";

    // --- POPULATE ADMIN LIST WITH LIVE INDICATOR ---
    db.ref('users').on('value', (snap) => {
        const select = document.getElementById('admin-target-user');
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Select Device --</option>';
        const now = Date.now();
        
        if(snap.exists()) {
            const users = snap.val();
            Object.keys(users).forEach(id => {
                const isOnline = (now - users[id].lastActive) < 15000; // Online if active in last 15s
                const status = isOnline ? "Online ğŸŸ¢" : `Last seen: ${users[id].lastSeen || '???'}`;
                
                const opt = document.createElement('option');
                opt.value = id;
                opt.innerText = `${id} (${status})`;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }
    });

    db.ref('users/' + myId).on('value', (snap) => {
        if(snap.exists()) stats = snap.val();
        updateUI();
    });

    function drinkWater() {
        const amt = parseInt(document.getElementById('drink-amount').value) || 0;
        const today = new Date().toLocaleDateString().replace(/\//g, '-');
        stats.daily = stats.daily || {};
        const old = stats.daily[today] || 0;
        stats.daily[today] = old + amt;

        if (stats.daily[today] >= stats.goal && old < stats.goal) {
            stats.coins = (stats.coins || 0) + 10;
            document.getElementById('love-overlay').style.display = 'flex';
        }
        updatePresence();
        db.ref('users/' + myId).set(stats);
    }

    function unlockAdmin() {
        if(prompt("Enter Admin Key:") === "0710") {
            document.getElementById('admin-controls').style.display = 'block';
        }
    }

    function switchAdminTarget() {
        adminTargetId = document.getElementById('admin-target-user').value;
        document.getElementById('admin-actions').style.display = adminTargetId ? 'block' : 'none';
    }

    function adminUpdateCoins() {
        const val = parseInt(document.getElementById('admin-coins').value);
        if(adminTargetId) db.ref('users/' + adminTargetId).update({coins: val});
    }

    function adminUpdateGoal() {
        const val = parseInt(document.getElementById('admin-goal').value);
        if(adminTargetId) db.ref('users/' + adminTargetId).update({goal: val});
    }

    function updateUI() {
        const today = new Date().toLocaleDateString().replace(/\//g, '-');
        const curr = (stats.daily && stats.daily[today]) ? stats.daily[today] : 0;
        document.getElementById('current-ml').innerText = curr;
        document.getElementById('coin-count').innerText = stats.coins || 0;
        document.getElementById('display-goal').innerText = stats.goal || 2000;
        const p = Math.min((curr / (stats.goal || 2000)) * 360, 360);
        document.getElementById('progress').style.background = `conic-gradient(#00d2ff ${p}deg, #ffebee 0deg)`;
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById('p-' + p).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
